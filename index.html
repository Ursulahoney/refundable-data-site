<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Refund Opportunities</title>
    <style>
      body {
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        max-width: 1100px;
        margin: 0 auto;
        padding: 1rem 1.5rem;
      }
      h1 {
        margin-bottom: 1rem;
      }
      table {
        border-collapse: collapse;
        width: 100%;
        table-layout: fixed;
      }
      th, td {
        border: 1px solid #ccc;
        padding: 6px;
        vertical-align: top;
        font-size: 0.9rem;
        word-wrap: break-word;
      }
      th {
        background: #f5f5f5;
        text-align: left;
      }
      a {
        text-decoration: none;
      }
    </style>

    <!-- CSV parser -->
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  </head>
  <body>
    <h1>Refund Opportunities</h1>
    <table id="results"></table>

    <script>
      // Make sure this CSV URL is for the *public_view* sheet
      const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQXzaJTWFPZp14JeAWkVsXgua5yclwwbmwRqgKpOzj6MFD7XcB1dJhWsEJdwh6nbB2K7VIGPYw8j8NO/pub?gid=1266693431&single=true&output=csv";

      async function loadData() {
        const res = await fetch(CSV_URL);
        const text = await res.text();

        const parsed = Papa.parse(text.trim(), { header: true });

        // Keep only rows that have at least one non-empty value
        const rows = parsed.data.filter(r =>
          r && Object.values(r).some(v => v && String(v).trim() !== "")
        );

        const table = document.getElementById("results");

        // Columns we want to *display* (not the sheet header names)
        const columns = ["found", "state", "category", "title", "eligible", "claim"];
        const labels = {
          found: "Found",
          state: "State",
          category: "Category",
          title: "Title",
          eligible: "Who is eligible",
          claim: "Claim link"
        };

        // Build header row
        const thead = document.createElement("thead");
        const headerRow = document.createElement("tr");
        columns.forEach(colKey => {
          const th = document.createElement("th");
          th.textContent = labels[colKey];
          headerRow.appendChild(th);
        });
        thead.appendChild(headerRow);
        table.appendChild(thead);

        const tbody = document.createElement("tbody");

        rows.forEach(row => {
          const keys = Object.keys(row);
          const tr = document.createElement("tr");

          columns.forEach(colKey => {
            const td = document.createElement("td");
            let value = "";

            if (colKey === "found") {
              // id or date-like field
              value =
                row["Found"] ||
                row["date_found"] ||
                row["id"] ||
                row["opportunity_id"] ||
                row[keys[0]];  // first column as fallback
            } else if (colKey === "state") {
              value =
                row["State"] ||
                row["state"] ||
                row["state_code"] ||
                row[keys[1]];  // second column as fallback
            } else if (colKey === "category") {
              value =
                row["Category"] ||
                row["category"] ||
                row["type"] ||
                row[keys[3]];  // fourth column as fallback
            } else if (colKey === "title") {
              value =
                row["Title"] ||
                row["title"] ||
                row["short_title"] ||
                row[keys[4]];  // fifth column as fallback
            } else if (colKey === "eligible") {
              value =
                row["Who is eligible"] ||
                row["who_is_eligible"] ||
                row["eligibility"] ||
                row["description"] ||
                row[keys[5]];  // sixth column as fallback
            } else if (colKey === "claim") {
              value =
                row["Claim link"] ||
                row["claim_url"] ||
                row["claim_website"] ||
                row["apply_url"] ||
                row[keys[7]];  // eighth column as fallback
            }

            if (colKey === "claim" && value) {
              const link = document.createElement("a");
              link.href = value;
              link.target = "_blank";
              link.rel = "noopener noreferrer";
              link.textContent = "Go to site";
              td.appendChild(link);
            } else {
              td.textContent = value || "";
            }

            tr.appendChild(td);
          });

          tbody.appendChild(tr);
        });

        table.appendChild(tbody);
      }

      loadData();
    </script>
  </body>
</html>
